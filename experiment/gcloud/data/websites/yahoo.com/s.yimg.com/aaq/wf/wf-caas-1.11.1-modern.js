!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("wafer-caas",[],t):"object"==typeof exports?exports["wafer-caas"]=t():(e.wafer=e.wafer||{},e.wafer.wafers=e.wafer.wafers||{},e.wafer.wafers["wafer-caas"]=t())}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var n=a[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="https://s.yimg.com/aaq/wf/",t(t.s="./src/entry.js")}({"./src/entry.js":function(e,t,a){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var l=window.wafer.utils,u=l.loadCSSSync,f=l.loadScriptAsync,d=/^https:\/\/s.yimg.com\/(os|aaq)\/c/,v=function(e,t,a,r){return Promise.all(e.map(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1],i=e.data,s=void 0===i?{}:i,o=s.partnerData;if(!o)return r&&r(n),Promise.resolve();var c=o.uuid,l={assets:t,items:[e]};return window.__waferCaasCollection.set(c,l),window.wafer.db.set({cachedTime:Date.now(),key:c+":"+a,ttl:1200,value:JSON.stringify(l)},"fetch").then(function(t){return t&&window.__waferCaasCollection.freeMemory(a),e}).catch(function(){return e})}))},h=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments[2];return new Promise(function(r){var n="sidekick"===a?"CAAS_SIDEKICK":"CAAS",i=void 0,s=!0,o=!0;window.__caasModules=window.__caasModules||{},e.forEach(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.type,a=e.asset;"js"===t&&a.value&&(s=!1),"css"===t&&(o=!1)}),e.forEach(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.type,c=e.asset;i=(void 0===c?{}:c).value,d.test(i)&&("js"===a?f({src:i},function(){s=!0,o&&r()},n):"css"===a&&(window.__caasModules[n]?(o=!0,s&&r()):(window.__caasModules[n]=!0,u({src:i,text:t},function(){o=!0,s&&r()}))))})})},m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},w=function(){function e(e,t){var a=[],r=!0,n=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),p=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),y=window.wafer,g=y.base,_=y.constants,b=y.utils,C=y.WaferBaseClass,k=_.ATTR_PREFIX,E=b.convertNodeListToArray,A=b.fetchWithCache,P=b.getConfigFromJSONScriptNode,L=b.setTimeout,S=["caas-category-label","caas-collapsed","caas-url","caas-uuid"],O=function(e){function t(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=a.caasConfig,s=a.errorClass,o=a.selector,c=a.successClass;r(this,t);var l=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,{errorClass:s,selector:o,successClass:c},{STATE_ATTRS:S})),u=e.getAttribute(k+"caas-cache"),f=e.getAttribute(k+"caas-collapsed"),d=e.getAttribute(k+"caas-url"),v=e.getAttribute(k+"caas-uuid"),h=e.getAttribute(k+"caas-cache-strategy")||"cacheFirst",p=e.getAttribute(k+"caas-cache-ttl"),y=e.getAttribute(k+"caas-category-label"),g=e.getAttribute("href"),_=e.getAttribute(k+"caas-prefetch"),b=e.getAttribute(k+"caas-timeout"),C=e.getAttribute(k+"caas-type")||"default",E=e.getAttribute(k+"caas-wrapper"),A=e.getAttribute(k+"caas-dependency"),O=A&&document.querySelector(A),T=(e.getAttribute(k+"caas-trigger-offset")||"").split(" "),I=w(T,2),N=I[0],j=I[1],x=e.getAttribute(k+"caas-item-count-balanced"),M=e.getAttribute(k+"caas-trigger")||"viewport";if(l._util=m({},l._util,{"caas-collapsed":null===f||void 0===f?0:Number(f),"caas-url":d,"caas-uuid":v,cache:null===u||void 0===u?1:Number(u),caasConfig:i,cacheStrategy:h,cacheTtl:null===p||void 0===p?300:Number(p),categoryLabel:y,dependencyElem:O,isPrefetch:null===_||void 0===_?0:Number(_),timeout:null===b||void 0===b?6e3:Number(b),elem:e,errorClass:s,href:g,type:C,offsetX:Number(j)||0,offsetY:Number(N)||0,selector:o,successClass:c,trigger:M,wrapper:E,isItemCountBalanced:null===x||void 0===x?0:Number(x)}),l._state={status:status},"sidekick"===C){var W=e.getAttribute(k+"caas-second-node"),D=W&&document.getElementById(W);D&&(l._util.secondNode=D)}else"renderedArticle"===C&&L(function(){var t=e.getElementsByClassName("wafer-caas-data")[0],a=t&&P(t);l.handleRenderedArticle(a)},0,l);return l}return i(t,e),p(t,[{key:"updateCategoryLabel",value:function(){var e=this._util,t=e["caas-category-label"],a=e.elem;if(a&&t){var r=E(a.getElementsByClassName("caas-category-label"))[0];r&&(r.innerHTML=t)}}},{key:"fetch",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=(t.disable,this._util["caas-url"]),r=this._util["caas-uuid"];if(!a&&!r)return Promise.reject(new Error("uuid and url is missing"));var n=this._util,i=n.dependencyElem,s=n.successClass;if(i&&!i.classList.contains(s))return Promise.reject(new Error("dependency not yet complete"));var o=this._util,c=o.caasConfig,l=void 0===c?{}:c,u=o.cache,f=o.cacheStrategy,d=o.cacheTtl,v=o.elem,m=o.errorClass,w=o.secondNode,p=o.timeout,y=o.type,_=r+":"+l.contextParams;if(v.classList.contains(s))return Promise.resolve(!0);if(0!==this._state.status){var b=!1;if(a){var C=-1===a.indexOf("?")?"?":"&";a=a+C+l.contextParams}else a=(l.caasUrl||"https://www.yahoo.com/caas/content/article/")+"?uuid="+r+"&"+l.contextParams;return v.classList.add("wafer-caas-trigger-inprogress"),this._state.status=0,new Promise(function(e,t){if("default"===y){var n=window.__waferCaasCollection.get(r);if(n)return b=!0,void e(n)}var i={cache:u,cacheKey:_,cacheStrategy:f,cacheTtl:d,timeout:p};-1===a.indexOf("s.yimg.com")&&(i.credentials="include"),A(a,i).then(function(t){e(t)}).catch(function(e){t(e)})}).then(function(e){var t=e.assets;if(!t.length)return e;if("sidekick"!==y&&window.CAAS)return e;var a=e.style;return h(t,a,y).then(function(){return e})}).then(function(t){var n=y.length?y[0].toUpperCase()+y.slice(1):"",i=e["handle"+n],o=t._fetchMeta||{},c=o.duration,l=o.source;g.destroy(v,{destroySelf:!1});var u=void 0;if("default"===y){var f=t||{},d=f.assets,h=f.items,m=void 0===h?[]:h,p={};m.length>1?m.some(function(e){return((e||{}).data||{}).partnerData.uuid===r&&(p=e,!0)}):p=m[0],u=(p||{}).markup,v.innerHTML=u,!b&&window.__waferCaasCollection.set(r,{assets:d,items:[p]})}else if("sidekick"===y)if(u=t.markup,w){var _=e._util.isItemCountBalanced,C=document.createElement("div"),k=document.createElement("div");C.innerHTML=u,k.innerHTML=u;for(var A=E(C.getElementsByClassName("sidekick-item")),P=A.length,L=Math.round(P/2)+ +!_,S=L;S<P;S++){var O=A[S].parentNode;O.parentNode.removeChild(O)}v.innerHTML=C.innerHTML;var T=E(k.getElementsByClassName("sidekick-item")),I=k.getElementsByClassName("caas-mobetta")[0];I&&I.parentNode.removeChild(I);for(var N=0;N<L;N++){var j=T[N].parentNode;j.parentNode.removeChild(j)}v.innerHTML=C.innerHTML,w.innerHTML=k.innerHTML}else v.innerHTML=u;if(e._util["caas-collapsed"]){var x=E(v.getElementsByClassName("caas-body-wrapper"))[0];x&&x.classList.add("caas-body-collapsed")}if(e.updateCategoryLabel(),i&&i.call(e,v,t),v.classList.remove("wafer-caas-trigger-inprogress"),v.classList.add(s),g.emitLog({name:"WaferCaas",elem:v,meta:{duration:c,source:b?"MEMORY":l,url:a}}),"default"===y){var M=t.items[0].data.partnerData;g.emitWaferEvent("caas:article:fetch",{elem:v,meta:{data:M,url:a}})}return!0}).catch(function(t){return g.emitWaferEvent("caas:"+("default"===y?"article":y)+":error",{elem:v,meta:{url:a,uuid:r},stack:t.stack}),v.classList.remove("wafer-caas-trigger-inprogress"),v.classList.add(m),v.classList.remove(s),g.destroy(v),e._state.status=2,!1})}return Promise.resolve(!1)}},{key:"handleSidekick",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=this._util,r=a["caas-url"],n=a.elem,i=a.secondNode;if(!t.markup)return void g.emitWaferEvent("caas:sidekick:error",{elem:n,meta:{url:r}});g.emitWaferEvent("caas:sidekick:init",{elem:n,meta:{url:r}}),this._state.status=1,g.sync(e),i&&g.sync(i)}},{key:"handleRenderedArticle",value:function(e){var t=this._util,a=t["caas-uuid"],r=t.elem,n=t.successClass;if(window.__waferCaasCollection.set(a,{items:[{data:{partnerData:m({},e,{uuid:a})}}]}),this.handleDefault(r),this._util["caas-collapsed"]){var i=E(r.getElementsByClassName("caas-body-wrapper"))[0];i&&i.classList.add("caas-body-collapsed")}this.updateCategoryLabel(),r.classList.add(n),g.emitLog({name:"WaferCaas",elem:r,meta:{}})}},{key:"handleDefault",value:function(e){var t=this,a=this._util,r=a["caas-uuid"],n=a.elem,i=a.type,s=window.__waferCaasCollection.get(r)||{},o=s.items,c=void 0===o?[]:o,l=w(c,1),u=l[0];u=void 0===u?{}:u;var f=u.data,d=u.markup;if(!("renderedArticle"===i||d&&f))return void g.emitWaferEvent("caas:article:error",{elem:n,meta:{uuid:r}});var h=f.partnerData;if(window._caasInstance)window._caasInstance.sync();else{var m=this._util.wrapper;window.wafer.base.pauseVideo("wafer-caas"),window._caasInstance=new window.CAAS.BASE({container:m}),window._caasInstance.on("link:clicked",function(e){if(e.isYahoo){var a=t._util.caasConfig,i=void 0===a?{}:a,s=i.contextParams,o=void 0===s?{}:s,c=(i.caasUrl||"https://www.yahoo.com/caas/content/article/")+"?url="+e.href+"&"+o;return g.emitWaferEvent("caas:yahooLink:clicked",{elem:n,meta:{data:e,instance:window._caasInstance}}),A(c,{timeout:2e3}).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.items,a=void 0===t?[]:t,r=e.assets;return v(a,r,o)}).then(function(t){var a=w(t,1),i=a[0];i=void 0===i?{}:i;var s=i.data,o=s.partnerData,c=void 0===o?{}:o,l=c.uuid;g.emitWaferEvent("caas:yahooLink:fetched",{elem:n,meta:{data:Object.assign({parentUuid:r,uuid:l},e),instance:window._caasInstance}})}).catch(function(){g.emitWaferEvent("caas:link:clicked",{elem:n,meta:{data:e,instance:window._caasInstance}})})}g.emitWaferEvent("caas:link:clicked",{elem:n,meta:{data:e,instance:window._caasInstance}})}),L(function(){g.emitWaferEvent("caas:article:init",{elem:n,meta:{data:h,instance:window._caasInstance}})},100,this)}this._state.status=1,g.sync(e)}},{key:"handleArticleInViewport",value:function(){var e=this._util,t=e.elem,a=e.type,r=e["caas-uuid"],n=window.__waferCaasCollection.get(r)||{},i=n.items,s=void 0===i?[]:i,o=w(s,1),c=o[0];c=void 0===c?{}:c;var l=c.data,u=c.markup;if("renderedArticle"===a||u&&l){var f=l.partnerData;g.emitWaferEvent("caas:article:inview",{elem:t,meta:{data:f,instance:window._caasInstance}})}}},{key:"stateDidUpdate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.stateAttr;if("caas-collapsed"!==t){if("caas-category-label"===t)return void this.updateCategoryLabel();"stateChange"===this._util.trigger&&this.fetch().catch(function(){})}else{if(!this._util.elem)return;if(this._util["caas-collapsed"]=Number(this._util["caas-collapsed"]),this._util["caas-collapsed"]){var a=E(this._util.elem.getElementsByClassName("caas-body-wrapper"))[0];a&&a.classList.add("caas-body-collapsed")}}}},{key:"config",get:function(){var e=this._util,t=e["caas-url"],a=e["caas-uuid"];return{caasConfig:e.caasConfig,href:e.href,isPrefetch:e.isPrefetch,offsetX:e.offsetX,offsetY:e.offsetY,selector:e.selector,trigger:e.trigger,type:e.type,url:t,uuid:a}}}]),t}(C),T=O,I=function(){function e(e,t){var a=[],r=!0,n=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),N=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),j=window.wafer,x=j.base,M=j.utils,W=M.elementInView,D=M.fetchWithCache,B=M.getConfigFromJSONScriptNode,H=M.throttle,R=window.wafer.controllers.WaferBaseController;window.__waferCaasCollection=function(){var e=[],t=new Map;return{set:function(a,r){e.push(a),t.set(a,r)},freeMemory:function(a){if(!(e.length<25)){var r=e[0];window.wafer.db.get(r+":"+a,"fetch",{timeout:1e3}).then(function(a){if(a){var n=e.indexOf(r);e.splice(n,1),t.delete(r)}}).catch(function(){})}},get:function(e){return t.get(e)}}}();var U=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.errorClass,r=void 0===a?"wafer-caas-error":a,n=e.root,i=void 0===n?document:n,c=e.selector,l=e.successClass,u=void 0===l?"wafer-caas-complete":l,f=e.validateDelay,d=void 0===f?25:f;s(this,t);var v=B(document.getElementById("wafer-caas-config"));v.caasUrl&&("https:"!==location.protocol||v.mock||(v.caasUrl="/caas/content/article/"));var h=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{root:i,selector:c,props:{caasConfig:v,errorClass:r,selector:c,successClass:u},WaferClass:T}));return h._validateWithThrottle=H(function(){h.validate()},d,h),h._state=h._state||{},h.sync(),h.addPublicAPIs(v),h}return c(t,e),N(t,[{key:"addPublicAPIs",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.contextParams,a=void 0===t?{}:t;window.wafer.caas||(window.wafer.caas={getData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return Promise.all(e.map(function(e){return new Promise(function(t){var r=window.__waferCaasCollection.get(e);if(r){var n=I(r.items,1),i=n[0].data;return t((void 0===i?{}:i).partnerData||{})}if(!window.wafer.db)return t({});window.wafer.db.get(e+":"+a,"fetch",{timeout:3e3}).then(function(e){try{var a=JSON.parse(e.value),r=a.items,n=I(r,1),i=n[0].data;return t((void 0===i?{}:i).partnerData||{})}catch(e){return t({})}}).catch(function(e){t({})})})}))}})}},{key:"prefetch",value:function(){var e=this._state.elementInstances,t={},a=[],r=[],n=void 0,i=void 0,s=void 0,o=0,c=0,l=!0,u=!1,f=void 0;try{for(var d,m=e.values()[Symbol.iterator]();!(l=(d=m.next()).done);l=!0){var w=d.value;a[o]=a[o]||[];var p=w.instance,y=p.config,g=y.caasConfig,_=void 0===g?{}:g,b=y.href,C=y.isPrefetch,k=y.uuid;if(s=s||_.caasUrl,i=i||_.contextParams||"",C&&k){var E=t[k];!E&&a[o].push({href:b,uuid:k}),t[k]=!0,p.destroy(),!E&&++c>=10&&(c=0,o++)}}}catch(e){u=!0,f=e}finally{try{!l&&m.return&&m.return()}finally{if(u)throw f}}return Promise.all(a.map(function(e){var t=e.map(function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).uuid});if(t.length)return n=(s||"https://www.yahoo.com/caas/content/article/")+"?uuid="+t.join(",")+"&"+i,D(n,{cache:0}).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.assets,a=e.items,r=void 0===a?[]:a,n={items:r,assets:t};return window.CAAS?n:h(t,"","default").then(function(){return n})}).then(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=t.assets,n=t.items;return v(void 0===n?[]:n,a,i,function(t){var a=e[t].href;a&&r.push(a)})})})).then(function(){if(r.length)return Promise.all(r.map(function(e){return D((s||"https://www.yahoo.com/caas/content/article/")+"?url="+e+"&"+i,{cache:0}).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.items,a=void 0===t?[]:t,r=e.assets;return v(a,r,i)})}))}).then(function(){x.emitWaferEvent("caas:prefetch:success",{meta:{url:n}})}).catch(function(){x.emitWaferEvent("caas:prefetch:failed",{meta:{url:n}})})}},{key:"handleScroll",value:function(){this._validateWithThrottle()}},{key:"handleResize",value:function(){this._validateWithThrottle()}},{key:"didSync",value:function(){var e=this,t=this._state,a=t.elementInstances,r=t.mounted;0===a.size||r||(this._state.mounted=!0),setTimeout(function(){e.prefetch()},10)}},{key:"trigger",value:function(e){var t=this._state.elementInstances.get(e);if(t){var a=t.instance;if("renderedArticle"===a.config.type)return;a.fetch()}}},{key:"willValidate",value:function(e){var t=this,a=this._state.elementInstances;e.forEach(function(e){var r=a.get(e),n=r.instance;if(!n.config.isPrefetch){var i=n.config,s=i.offsetX,o=i.offsetY,c=i.selector,l=i.trigger,u=i.type,f=W(e,{offsetX:s,offsetY:o},x.viewport);if("renderedArticle"!==u)switch(l){case"viewport":1!==n._state.status&&f&&n.fetch().then(function(t){t&&c&&e.classList.remove(c.replace(".",""))}).catch(function(){});break;case"onLoad":n.fetch().then(function(t){t&&c&&e.classList.remove(c.replace(".",""))}).catch(function(){})}f&&t._state.activeElem===e||t._state.activeElem&&W(t._state.activeElem,{offsetX:s,offsetY:o},x.viewport)||1!==n._state.status||!f||"default"!==u&&"renderedArticle"!==u||t._state.activeElem!==e&&(n.handleArticleInViewport(),t._state.activeElem=e)}})}},{key:"didDestroy",value:function(e){this._state.activeElem===e&&(this._state.activeElem=null);var t=!0,a=this._state.elementInstances,r=!0,n=!1,i=void 0;try{for(var s,o=a.values()[Symbol.iterator]();!(r=(s=o.next()).done);r=!0){var c=s.value,l=c.instance.config,u=l.isPrefetch;if("default"===l.type&&!u){t=!1;break}}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}t&&(window._caasInstance&&(window._caasInstance.destructor(),window._caasInstance=null),window.wafer.base.resumeVideo("wafer-caas"))}}]),t}(R),Y=U;t.default=new Y({selector:"wafer-caas"})}})});